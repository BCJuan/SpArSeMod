

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using SpArSeMoD &mdash; SpArSeMoD v0.1.2 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Extending Sparse" href="extending_sparse.html" />
    <link rel="prev" title="Getting Started" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> SpArSeMoD
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using SpArSeMoD</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#main-call-and-configuration-file">Main Call and Configuration file</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuration-file">Configuration file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#test-configuration">Test configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#data-loading">Data Loading</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#collates">Collates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusions">Conclusions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#search-space">Search Space</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mandatory-variables">Mandatory variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#network-builder">Network Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="#morphisms">Morphisms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inspecting-results">Inspecting results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#csv-results">.csv results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#best-configuration-details">Best configuration details</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extending_sparse.html">Extending Sparse</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SpArSeMoD</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Using SpArSeMoD</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/using_sparse.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-sparsemod">
<h1>Using SpArSeMoD<a class="headerlink" href="#using-sparsemod" title="Permalink to this headline">¶</a></h1>
<p>To use SpArSeMoD you have to build several components:</p>
<ul class="simple">
<li><p>Data Loading</p></li>
<li><p>Search Space</p></li>
<li><p>Network builder</p></li>
<li><p>Configuration file</p></li>
<li><p>Main call</p></li>
<li><p>Morphisms</p></li>
</ul>
<p>We have seen some of them in the <a class="reference internal" href="getting_started.html"><span class="doc">Getting Started</span></a> guide. In this section we are going to explain with a little bit of detail each of the documents.</p>
<p>Apart from the main optimization procedure to inspect the resulting data, some ax <code class="docutils literal notranslate"><span class="pre">Experiment</span></code> object inspection is needed, as well as some <code class="docutils literal notranslate"><span class="pre">.csv</span></code> wrangling.</p>
<div class="section" id="main-call-and-configuration-file">
<h2>Main Call and Configuration file<a class="headerlink" href="#main-call-and-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>SpArSeMoD internals are not directly accessible and it consists mainly in a simple call with some configurational parameters. The call to SpArSeMoD is made as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sparse_instance</span> <span class="o">=</span> <span class="n">Sparse</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">sparse_instance</span><span class="o">.</span><span class="n">run_sparse</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Sparse</span></code> object instantiation has a signature which corresponds to the different configuration parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sparse</span><span class="p">(</span>
    <span class="n">r1</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">]),</span>
    <span class="n">r2</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;R2&quot;</span><span class="p">]),</span>
    <span class="n">r3</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;R3&quot;</span><span class="p">]),</span>
    <span class="n">epochs1</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;EPOCHS1&quot;</span><span class="p">]),</span>
    <span class="n">epochs2</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;EPOCHS2&quot;</span><span class="p">]),</span>
    <span class="n">epochs3</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;EPOCHS3&quot;</span><span class="p">]),</span>
    <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]),</span>
    <span class="n">root</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;ROOT&quot;</span><span class="p">],</span>
    <span class="n">objectives</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;OBJECTIVES&quot;</span><span class="p">]),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;BATCH_SIZE&quot;</span><span class="p">]),</span>
    <span class="n">morphisms</span><span class="o">=</span><span class="n">bool_converter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;MORPHISMS&quot;</span><span class="p">]),</span>
    <span class="n">pruning</span><span class="o">=</span><span class="n">bool_converter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;PRUNING&quot;</span><span class="p">]),</span>
    <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
    <span class="n">classes</span><span class="o">=</span><span class="n">n_classes</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="n">bool_converter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">]),</span>
    <span class="n">search_space</span><span class="o">=</span><span class="n">search_space</span><span class="p">,</span>
    <span class="n">net</span><span class="o">=</span><span class="n">Net</span><span class="p">,</span>
    <span class="n">flops</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;FLOPS&quot;</span><span class="p">]),</span>
    <span class="n">quant_scheme</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;QUANT_SCHEME&quot;</span><span class="p">]),</span>
    <span class="n">quant_params</span><span class="o">=</span><span class="n">quant_params</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">bool_converter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;SPLITTER&quot;</span><span class="p">]),</span>
    <span class="n">morpher_ops</span><span class="o">=</span><span class="n">operations</span><span class="p">)</span>
</pre></div>
</div>
<p>Most of those parameters are defined in the configuration file, which we will see next in this section. However, some of them are defined in the main call. From the example in <img alt="cnn_cost_example" src="_images/cnn_cost_example" />:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">datasets</span><span class="p">,</span> <span class="n">n_classes</span> <span class="o">=</span> <span class="n">prepare_cost</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;../data/data_cost/files&quot;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">search_space</span> <span class="o">=</span> <span class="n">search_space</span><span class="p">()</span>
    <span class="n">quant_params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">collate_fn</span> <span class="o">=</span> <span class="n">split_arrange_pad_n_pack</span>
</pre></div>
</div>
<p>The first line is the dataset definition, defined in the further section [Data Loading](## Data Loading). It returns a list of the different sets (training, validation and test) and the number of classes. The second line returns an Ax <code class="docutils literal notranslate"><span class="pre">SearchSpace</span></code> object as defined in the section [Search Space](## Search Space). The parameter <code class="docutils literal notranslate"><span class="pre">quant_params</span></code> serves for defining the PyTorch <code class="docutils literal notranslate"><span class="pre">nn</span></code> modules that you want to quantize thorugh dynamic quantization (for example, <code class="docutils literal notranslate"><span class="pre">quant_params</span> <span class="pre">=</span> <span class="pre">[nn.Linear,</span> <span class="pre">nn.LSTM]</span></code>). We will review it in the configuration file description. And finally, the <code class="docutils literal notranslate"><span class="pre">collate_fn</span></code> is a variable for storing the collate fucntion, explained in [the collate section](### Collates).</p>
<p>Those four parameters are the ones defined in the call function and not throguh the configuration file (although you could define all parameters in the main call without using a configuration file).</p>
<div class="section" id="configuration-file">
<h3>Configuration file<a class="headerlink" href="#configuration-file" title="Permalink to this headline">¶</a></h3>
<p>The configuration file serves as a parametrization of the SpArSe procedure (see <img alt="theory" src="_images/theory.md" /> for more information. Next a detail of the different parameters found in the configuration file is defined:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[DEFAULT]
train: BOOL 
    Defines whether we are in train mode or not. Normal usage is train = True. See Test section for a more detailed explanation.

[TRAIN] # train mode configuration
r1: INT
    Number of rounds in the first stage of optimization. With batch size of 1 this shouuld correspond to r1 random configurations
r2: INT
    Number of rounds in the second stage of optimization. Arc or Matern Kernel based Gaussian Process (GP) optimization. r2*batch configurations
r3: INT
    Number of rounds in the third stage. COnfigurations based in morphisms of the pareto frontier.
epochs1: INT
    Training epochs of each configuration at stage 1
epochs2: INT
    Training epochs of each configuration at stage 2
epochs3: INT
    Training epochs of each configuration at stage 3
name: STRING
    Name for the files where SpArSeMoD experiment and results are saved, both csv and json
root: STRING
    Folder where results are saved
objectives: INT
    Number of objectives included. It is incremental:
        1: accuracy
        2: accuracy, model size
        3: accuracy, model size, working memory
        4: accuracy, model size, working memory, latency
batch_size: INT
    Batch size for the Ax GP procedure. That means that if you define 3 as batch size, at each round  three different configurations are tested.
debug: BOOL
    Due to some networks created being too big for some images or feature maps, some times a `RuntimeError` occurs. For this reason, those errors are not directly raised. If you would like to inspect such errors produced, just activate this DEBUG param (will not raise them, but will print them)
flops: INT
    Frequency of your deployment platform. TO compute final latency in the platform.
quant_scheme: STRING
    PyTorch quantization scheme used. There are three possibilities activated trhough three keywords:
        post: post training static quantization
        dynamic: dynamic quantization
        both: applies to some parts post training static quantization and to some dynamic. Must be defined in the network builder.
    Check the PyTorch quantization procedure for more details
morphisms: BOOL
    Carry on with the third stage or not (equivalent to saying r3=0)
pruning: BOOL
    Use pruning during training or not.
splitter: BOOL
    Switch to activate `max_len` parameter if appropriate in the collate fn. Check the section ## COllates in the documentation
</pre></div>
</div>
<p>This is the minimum configuration for being able to use SpArSeMoD. The configuration file, <code class="docutils literal notranslate"><span class="pre">config.cfg</span></code> is simply called and read as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sparsemod.sparse.utils_data</span> <span class="kn">import</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">bool_converter</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">(</span><span class="s2">&quot;TRAIN&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and then the parameters used as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]),</span>
<span class="n">root</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;ROOT&quot;</span><span class="p">],</span>
<span class="n">objectives</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;OBJECTIVES&quot;</span><span class="p">]),</span>
<span class="n">batch_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;BATCH_SIZE&quot;</span><span class="p">]),</span>
<span class="n">morphisms</span><span class="o">=</span><span class="n">bool_converter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;MORPHISMS&quot;</span><span class="p">]),</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="section" id="test-configuration">
<h4>Test configuration<a class="headerlink" href="#test-configuration" title="Permalink to this headline">¶</a></h4>
<p>As you can see in the configuration file, there is a section for defining a “test” configuration. Why does this exist? The problem with neural network configuration and architecture testing is that you might want to do cross splits for testing or test the same configuration several times (not possible right now) and then test the chosen configuration in the test but at the end.</p>
<p>The idea of this test is the following, you optimize with you validation set and then when you have your best working configuration you test it by doing cross splits of the whole dataset and obtain a final result.</p>
<p>Parameters are very similar to the training ones.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[TEST]
pruning: BOOL
    Use pruning during training or not.
splitter: BOOL
    Switch to activate `max_len` parameter if appropriate in the collate fn. Check the section ## COllates in the documentation
quant_scheme: STRING
    PyTorch quantization scheme used. There are three possibilities activated trhough three keywords:
        post: post training static quantization
        dynamic: dynamic quantization
        both: applies to some parts post training static quantization and to some dynamic. Must be defined in the network builder.
    Check the PyTorch quantization procedure for more details
objectives: INT
    Number of objectives included. It is incremental:
        1: accuracy
        2: accuracy, model size
        3: accuracy, model size, working memory
        4: accuracy, model size, working memory, latency
name: STRING
    Name for the files where SpArSeMoD experiment and results are saved, both csv and json
root: STRING
    Folder where results are saved
epochs: INT
    Number of epochs to train the model 
arm: STRING
    Arm number of the best configuration
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-loading">
<h2>Data Loading<a class="headerlink" href="#data-loading" title="Permalink to this headline">¶</a></h2>
<p>SpArSeMoD uses PyTorch  <code class="docutils literal notranslate"><span class="pre">TensorDataset</span></code> (although any object built upon <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> should work) and the main loading function must return a list of the training, validation and test sets, altogether with the number of classes in the dataset. For example, let’s take a look at the way we load the data from MNIST (the code can be found at `)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prepare_mnist</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads mnist, samples from it a validation dataset in a stratified manner</span>
<span class="sd">    and returns train, val and test dataset</span>

<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    list of datasets</span>
<span class="sd">    number of classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trainset</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span>
        <span class="n">root</span><span class="o">=</span><span class="s2">&quot;./data/data_mnist&quot;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform_mnist</span><span class="p">(),</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">val_set</span><span class="p">,</span> <span class="n">tr_set</span> <span class="o">=</span> <span class="n">sample_from_class</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">ts_set</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span>
        <span class="n">root</span><span class="o">=</span><span class="s2">&quot;./data/data_mnist&quot;</span><span class="p">,</span>
        <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform_mnist</span><span class="p">(),</span>
        <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tr_set</span><span class="p">,</span> <span class="n">val_set</span><span class="p">,</span> <span class="n">ts_set</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">MNIST</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
</pre></div>
</div>
<p>First, we are loading the training set with a simple transform</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">transform_mnist</span><span class="p">():</span>
    <span class="s2">&quot;Transforms for the mnist dataset&quot;</span>
    <span class="k">return</span> <span class="n">Compose</span><span class="p">([</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))])</span>
</pre></div>
</div>
<p>Then, with <code class="docutils literal notranslate"><span class="pre">val_set,</span> <span class="pre">tr_set</span> <span class="pre">=</span> <span class="pre">sample_from_class(trainset,</span> <span class="pre">500)</span></code> we are splitting the training data set in a stratified manner into training and validation leaving 500 samples of each class. That is, we end up with a validation set of 500 examples of each class. The important point, however, is the type of object that it returns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">(</span>
        <span class="n">TensorDataset</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_label</span><span class="p">),</span>
        <span class="n">TensorDataset</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_label</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>And that is what SpArSeMoD uses. Finally, after obtaining the test set, we retunr what is needed for SpArSeMoD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">return</span> <span class="p">[</span><span class="n">tr_set</span><span class="p">,</span> <span class="n">val_set</span><span class="p">,</span> <span class="n">ts_set</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">MNIST</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
</pre></div>
</div>
<p>which would be called like: <code class="docutils literal notranslate"><span class="pre">datasets,</span> <span class="pre">classes</span> <span class="pre">=</span> <span class="pre">prepare_mnist()</span></code></p>
<div class="section" id="collates">
<h3>Collates<a class="headerlink" href="#collates" title="Permalink to this headline">¶</a></h3>
<p>There is the possibility of modifying the input data, for example, for standardizing it, through a <code class="docutils literal notranslate"><span class="pre">collate_fn</span></code>. The idea is that you define your collate before hand and pass it to SpArSeMoD which will use it in its internally defined dataloaders.</p>
<p>Let’s take a look at the CoST collate in the example <img alt="cnn_cost_example" src="_images/cnn_cost_example" />:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">split_arrange_pad_n_pack</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">max_len</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collate that splits the sequences of the cost dataset</span>
<span class="sd">    then arranges them in smaller sequences. When arranging them</span>
<span class="sd">    in smaller sequences also rearranges the values in them according</span>
<span class="sd">    to the Cost configuration (check COst readme regarding how the values</span>
<span class="sd">    are ordered). That is way there is this line</span>
<span class="sd">    `[i[[7, 6, 5, 4, 3, 2, 1, 0], :] for i in img_sequence]` and the fact that the 2 and 3</span>
<span class="sd">    dimensions are now (8, 8). This is due all to the cost data configuration</span>
<span class="sd">    To use as collate when dataloading cost and previously made a partial</span>
<span class="sd">    and the max len argument is fixed</span>

<span class="sd">    Args</span>
<span class="sd">    ---</span>
<span class="sd">    data: data argument that as collate needs for when called by the dataloader</span>
<span class="sd">    max_len: argument to fix the maximum lenght of the subsequences</span>

<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    pack_padded_data: each subsequence padded and packed for RNN consumption</span>
<span class="sd">    new_t_labels: label for each sequence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t_seqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tensor</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">stack</span><span class="p">([</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tlong</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">new_t_seqs</span><span class="p">,</span> <span class="n">new_t_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seq</span><span class="p">,</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t_seqs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
            <span class="n">n_seqs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_len</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_seqs</span><span class="p">):</span>
                <span class="n">img_sequence</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span>
                    <span class="n">seq</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="n">max_len</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">max_len</span> <span class="o">+</span> <span class="n">max_len</span><span class="p">),</span> <span class="p">:]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
                <span class="n">img_sequence</span> <span class="o">=</span> <span class="n">stack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">i</span><span class="p">[[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">img_sequence</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
                <span class="n">new_t_seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_sequence</span><span class="p">)</span>
                <span class="n">new_t_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">len_diff</span> <span class="o">=</span> <span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="n">len_diff</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">stack</span><span class="p">([</span><span class="n">i</span><span class="p">[[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">final_seq</span> <span class="o">=</span> <span class="n">cat</span><span class="p">((</span><span class="n">seq</span><span class="p">,</span> <span class="n">padding</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">new_t_seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_seq</span><span class="p">)</span>
            <span class="n">new_t_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stack</span><span class="p">(</span><span class="n">new_t_seqs</span><span class="p">),</span> <span class="n">tensor</span><span class="p">(</span><span class="n">new_t_labels</span><span class="p">)</span>
</pre></div>
</div>
<p>All in all, works as a normal <code class="docutils literal notranslate"><span class="pre">collate_fn</span></code> since it returns a batch of inputs and labels. In the current version of SpArSeMoD, there is the possibility of adding an especial parameter to the collate: <code class="docutils literal notranslate"><span class="pre">max_len</span></code>. This is parameter is intended to be used when classifying sequences. The idea is that you define in your search space a <code class="docutils literal notranslate"><span class="pre">max_len</span></code> parameter as in the <img alt="cnn_cost_example" src="_images/cnn_cost_example" /> and then when the collate is used it will split the sentence. The usage of this parameter is entirely optional.</p>
<p>The collate function should be passed to SpArSeMoD as an uninstantiaed function, i.e.     <code class="docutils literal notranslate"><span class="pre">collate_fn</span> <span class="pre">=</span> <span class="pre">split_arrange_pad_n_pack</span></code></p>
<p>and then in the <code class="docutils literal notranslate"><span class="pre">Sparse</span></code> instantiation</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cnn2d_cost</span> <span class="kn">import</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">Net</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">split_arrange_pad_n_pack</span>
<span class="o">....</span>

<span class="n">sparse_instance</span> <span class="o">=</span> <span class="n">Sparse</span><span class="p">(</span>
    <span class="o">...</span> 
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
    <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusions">
<h3>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h3>
<p>So, what does SpArSeMoD need for using data:</p>
<ul class="simple">
<li><p>The data must be in encapsulated in a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object (or child of it)</p></li>
<li><p>The loading function must return a list of the training, validation and test sets and the number of classes
<code class="docutils literal notranslate">&#160;&#160;&#160; <span class="pre">return</span> <span class="pre">[tr_set,</span> <span class="pre">val_set,</span> <span class="pre">ts_set],</span> <span class="pre">n_classes</span></code></p></li>
<li><p>The data is called as <code class="docutils literal notranslate"><span class="pre">datasets,</span> <span class="pre">classes</span> <span class="pre">=</span> <span class="pre">prepare_data()</span></code></p></li>
</ul>
</div>
</div>
<div class="section" id="search-space">
<h2>Search Space<a class="headerlink" href="#search-space" title="Permalink to this headline">¶</a></h2>
<p>SpArSeMoD uses a search space definition from <img alt="Ax" src="https://ax.dev/" /> in the <img alt="developed mode" src="https://ax.dev/tutorials/gpei_hartmann_developer.html" />. Hence, all parameters use the same API.</p>
<p>To define a parmeter we just pick the type of parameter among different possibilities:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RangeParameter</span></code>: parameters with upper and lower bounds and data type fixed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ChoiceParameter</span></code>: Different possibilities like in a set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FixedParameter</span></code></p></li>
</ul>
<p>Let’s see an example of <code class="docutils literal notranslate"><span class="pre">RangeParameter</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RangeParameter</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;param_name&quot;</span><span class="p">,</span>
    <span class="n">lower</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">upper</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p><em>An important point is the name that we give to the parameter: we will use it in the network builder</em></p>
<p>One of the main problems of Ax and, in general, Gaussian Process based optimizers, is that they do not tolerate <em>ab initio</em> conditional or hierarchical parameters. Hence we must link them ourselves. For example, we may use  parameter for the number of convolutional layers, another for the number of layers at the first of them and so on.</p>
<p>This idea is used in examples such as <img alt="Cost example" src="_images/cnn2d_cost.py" />. Let’s see how in the case of convolutions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">max_number_of_blocks</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">max_number_of_layers_per_block</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">max_fc_layers</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">RangeParameter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;num_conv_blocks&quot;</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="n">max_number_of_blocks</span><span class="p">,</span>
            <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_number_of_blocks</span><span class="p">):</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RangeParameter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;downsample_input_depth_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RangeParameter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_downsampling_rate_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">lower</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">upper</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RangeParameter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_num_layers&quot;</span><span class="p">,</span>
                <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">upper</span><span class="o">=</span><span class="n">max_number_of_layers_per_block</span><span class="p">,</span>
                <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RangeParameter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;drop_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">lower</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">upper</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_number_of_layers_per_block</span><span class="p">):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">RangeParameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_filters&quot;</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">RangeParameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_kernel&quot;</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">RangeParameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_type&quot;</span><span class="p">,</span>
                    <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">RangeParameter</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_downsample&quot;</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>As we can see we have a variable <code class="docutils literal notranslate"><span class="pre">max_number_of_blocks</span> <span class="pre">=</span> <span class="pre">2</span></code>, which defines the first loop.  Then we have subvariables for next loops <code class="docutils literal notranslate"><span class="pre">max_number_of_layers_per_block</span> <span class="pre">=</span> <span class="pre">3</span></code>. We use a first loop to define variables at this hierarchical level, such as the number of layers in that convolutional block</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_number_of_blocks</span><span class="p">):</span>
<span class="o">...</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">RangeParameter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_num_layers&quot;</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="n">max_number_of_layers_per_block</span><span class="p">,</span>
            <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>and then, inside this loop, we define other sub loops such as the number of filters for each of the layers at each of the convolution bolocks.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_number_of_blocks</span><span class="p">):</span>
<span class="o">...</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_number_of_layers_per_block</span><span class="p">):</span>
    <span class="o">...</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">RangeParameter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_filters&quot;</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">parameter_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">INT</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Finally we transform the list of parameters into a <code class="docutils literal notranslate"><span class="pre">SearchSpace</span></code> object: <code class="docutils literal notranslate"><span class="pre">search_space</span> <span class="pre">=</span> <span class="pre">SearchSpace(parameters=params)</span></code> which will be used by SpArSeMoD.</p>
<p>Important to note is that we can also include constraints between parameters, such as a sum constraint or magnitude. See <code class="docutils literal notranslate"><span class="pre">ParameterConstraint</span></code> at <img alt="Ax" src="https://ax.dev/api/core.html?highlight=parameter#module-ax.core.parameter" />.</p>
<p>This is a proposal for defining the search space with Ax variables. However, we can use whatever way we desire iff we use an Ax search space type parameters and object.</p>
<p>To use it, import it in the Sparse main call and add it to <code class="docutils literal notranslate"><span class="pre">Sparse</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cnn</span> <span class="kn">import</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">Net</span><span class="p">,</span> <span class="n">operations</span>
<span class="o">....</span>
<span class="n">search_</span><span class="p">:</span><span class="n">space</span> <span class="o">=</span> <span class="n">search_space</span><span class="p">()</span>

<span class="n">sparse_instance</span> <span class="o">=</span> <span class="n">Sparse</span><span class="p">(</span>
    <span class="o">...</span> 
    <span class="n">search_space</span><span class="o">=</span><span class="n">search_space</span><span class="p">,</span>
    <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="mandatory-variables">
<h3>Mandatory variables<a class="headerlink" href="#mandatory-variables" title="Permalink to this headline">¶</a></h3>
<p>There are some variables that, due to the fact tht SpArSeMoD uses them internally, are mandatory in the search space.</p>
<p>The manadatory variables are:</p>
<ul class="simple">
<li><p>“learning_rate”</p></li>
<li><p>“learning_gamma”</p></li>
<li><p>“learning_step”</p></li>
<li><p>“prune_threshold” (you can fix it as 1 and there will be no pruning)</p></li>
<li><p>“batch_size”</p></li>
</ul>
</div>
<div class="section" id="conclusion">
<h3>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h3>
<p>We need to:</p>
<ul class="simple">
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">SearchSpace</span></code> object with Ax parameters</p></li>
<li><p>The names used will be used by the network builder</p></li>
</ul>
</div>
</div>
<div class="section" id="network-builder">
<h2>Network Builder<a class="headerlink" href="#network-builder" title="Permalink to this headline">¶</a></h2>
<p>The next element that has to be built is the network builder. It will use the parameters defined in the search space. Generally, it is like a PyTorch Module but being able to accept a configuration dictionary to build the specific network.</p>
<p>Let’s see the class signature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parametrization</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>as see it needs to have three parameters: the dictionary containing the specific configuration, the number of classes, and the input shape.</p>
<p>More requirements are the following. It obviously needs to have a <code class="docutils literal notranslate"><span class="pre">forward</span></code> method, and if quantization is in use, you need to have a <code class="docutils literal notranslate"><span class="pre">fuse</span> <span class="pre">modules</span></code> method.</p>
<p>Regarding how it workd, it basically is a generalized network builder. For example to build the convolutional part of a network it first deines a general loop for each block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">conv_blocks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_conv_blocks&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">conv_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_conv_block</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">channels</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">conv_blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">conv_blocks</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">parametrization</span></code> contains the dictionary of the configuration, and <code class="docutils literal notranslate"><span class="pre">self.create_conv_block</span></code> is a functon for building each block. In it we can see a generalized convolution builder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_conv_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">channels</span><span class="p">):</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_num_layers&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">conv_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_type&quot;</span><span class="p">,</span> <span class="s2">&quot;Conv2D&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">index_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_num_layers&quot;</span><span class="p">,</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">index_b</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_l</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">index_b</span> <span class="o">=</span> <span class="n">j</span>

            <span class="n">in_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_b</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_l</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_filters&quot;</span><span class="p">,</span> <span class="n">channels</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">conv_type</span> <span class="o">==</span> <span class="s2">&quot;SeparableConv2D&quot;</span><span class="p">:</span>
                <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">DepthwiseSeparableConv</span><span class="p">(</span>
                    <span class="n">in_channels</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_filters&quot;</span><span class="p">,</span> <span class="mi">6</span>
                    <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_kernel&quot;</span><span class="p">,</span> <span class="mi">3</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">conv_type</span> <span class="o">==</span> <span class="s2">&quot;DownsampledConv2D&quot;</span><span class="p">:</span>
                <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">DownsampleConv</span><span class="p">(</span>
                    <span class="n">in_channels</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_filters&quot;</span><span class="p">,</span> <span class="mi">6</span>
                    <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_kernel&quot;</span><span class="p">,</span> <span class="mi">3</span>
                    <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_downsample&quot;</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">conv_type</span> <span class="o">==</span> <span class="n">search_</span><span class="p">:</span><span class="n">space</span> <span class="o">=</span> <span class="n">search_space</span><span class="p">()</span><span class="n">hannels</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_filters&quot;</span><span class="p">,</span> <span class="mi">6</span>
                        <span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_kernel&quot;</span><span class="p">,</span> <span class="mi">3</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv_layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;downsample_input_depth_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;input_downsampling_rate_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;input_downsampling_rate_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">conv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Droposearch_</span><span class="p">:</span><span class="n">space</span> <span class="o">=</span> <span class="n">search_space</span><span class="p">()</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">forward</span></code> method, if quantization is used, you should include the <code class="docutils literal notranslate"><span class="pre">QuantStub</span></code> and <code class="docutils literal notranslate"><span class="pre">DeQuantStub</span></code> operators as specified in PyTorch quantization guidelines. For example, for only post training static quantization, we could do</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Global forward pass for both the convolution blocks and the fully</span>
<span class="sd">    connected layers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_features</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametrization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_fc_layers&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dequant</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
<p>In general, regarding quantization, you can follow the pytorch quantization guidelines since the quantization procedures have been made following those procedures.</p>
<p>Once you have defined your network builder, you have to import it in your <code class="docutils literal notranslate"><span class="pre">main</span></code> function and pass it to <code class="docutils literal notranslate"><span class="pre">Sparse</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cnn</span> <span class="kn">import</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">Net</span><span class="p">,</span> <span class="n">operations</span>
<span class="o">....</span>
<span class="n">sparse_instance</span> <span class="o">=</span> <span class="n">Sparse</span><span class="p">(</span>
    <span class="o">...</span> 
    <span class="n">net</span><span class="o">=</span><span class="n">Net</span><span class="p">,</span>
    <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="morphisms">
<h2>Morphisms<a class="headerlink" href="#morphisms" title="Permalink to this headline">¶</a></h2>
<p>Morphisms correspond to the third stage of the procedure. Morphisms basically consist in hard coded functions that modify the configurtion specifically. As those operations are architecture dependent they have to be defined by the user. They are linked to the parameters defined in the Search Space and then they should use the same names.</p>
<p>Let’s see an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">kernel_size</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes the kernel in a randomly chosen convolution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_conv_blocks&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_num_layers&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">new_kernel_size</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;conv_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_layer_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_kernel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_kernel_size</span>
    <span class="k">return</span> <span class="n">config</span>
</pre></div>
</div>
<p>Here we see the only two things that are mandatory for a morphism in SpArSeMoD, the argument must only be a dictionary containng the configurations and the retunrn must be that modified dictionary. In this latter case, we can see that the morphism detailed changes the kernel size of a random convolution layer of the network.</p>
<p>Once you have defined your morphims, grouped them in a dictionary, as for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">operations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;num_fc_layers&quot;</span><span class="p">:</span> <span class="n">num_fc_layers</span><span class="p">,</span>
    <span class="s2">&quot;num_conv_blocks&quot;</span><span class="p">:</span> <span class="n">num_conv_blocks</span><span class="p">,</span>
    <span class="s2">&quot;layer_type&quot;</span><span class="p">:</span> <span class="n">layer_type</span><span class="p">,</span>
    <span class="s2">&quot;num_conv_filters&quot;</span><span class="p">:</span> <span class="n">num_conv_filters</span><span class="p">,</span>
    <span class="s2">&quot;kernel_size&quot;</span><span class="p">:</span> <span class="n">kernel_size</span><span class="p">,</span>
    <span class="s2">&quot;downsampling_rate&quot;</span><span class="p">:</span> <span class="n">downsampling_rate</span><span class="p">,</span>
    <span class="s2">&quot;num_fc_weights&quot;</span><span class="p">:</span> <span class="n">num_fc_weights</span><span class="p">,</span>
    <span class="s2">&quot;num_conv_layers&quot;</span><span class="p">:</span> <span class="n">num_conv_layers</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then import them in the main function and add them to Sparse</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cnn</span> <span class="kn">import</span> <span class="n">search_space</span><span class="p">,</span> <span class="n">Net</span><span class="p">,</span> <span class="n">operations</span>
<span class="o">....</span>

<span class="n">sparse_instance</span> <span class="o">=</span> <span class="n">Sparse</span><span class="p">(</span>
    <span class="o">...</span> 
    <span class="n">morpher_ops</span><span class="o">=</span><span class="n">operations</span><span class="p">,</span>
    <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="inspecting-results">
<h2>Inspecting results<a class="headerlink" href="#inspecting-results" title="Permalink to this headline">¶</a></h2>
<p>Sparse produces two files for the results, one <code class="docutils literal notranslate"><span class="pre">.csv</span></code> where the performance results of each cofigurationn are save along the arm name, and a <code class="docutils literal notranslate"><span class="pre">.json</span></code> where the experiment is saved.</p>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">.csv</span></code> to recover the values of the performance and the <code class="docutils literal notranslate"><span class="pre">.json</span></code> to recover the parameter of the best configuration.</p>
<div class="section" id="csv-results">
<h3>.csv results<a class="headerlink" href="#csv-results" title="Permalink to this headline">¶</a></h3>
<p>If you take a look at a <code class="docutils literal notranslate"><span class="pre">.csv</span></code>, you will see that the results do not resemble real values corresponding to model size, ram or ltency. That is because results are standarized internally by SpArSeMoD to be able to put all objectives in more or less the same range ([0,1]). The only performance value that can be read directly is accuracy. The others must be transformed.</p>
<p>An example of all the procedure can be found at <img alt="cnn_cost_example" src="_images/visualizing_results.ipynb" /> in the form of a jupyter notebook tutorial.</p>
</div>
<div class="section" id="best-configuration-details">
<h3>Best configuration details<a class="headerlink" href="#best-configuration-details" title="Permalink to this headline">¶</a></h3>
<p>To be able to see a configuration specific parameters the following procedure is required.</p>
<ol class="simple">
<li><p>Reload the experiment as if you were to run SpArSe again</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">sparse_exp</span> <span class="o">=</span> <span class="n">SparseExperiment</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">]),</span>
        <span class="n">root</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;ROOT&quot;</span><span class="p">],</span>
        <span class="n">objectives</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;OBJECTIVES&quot;</span><span class="p">]),</span>
        <span class="n">pruning</span><span class="o">=</span><span class="n">bool_converter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;PRUNING&quot;</span><span class="p">]),</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;epochs1&quot;</span><span class="p">],</span>
        <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
        <span class="n">classes</span><span class="o">=</span><span class="n">n_classes</span><span class="p">,</span>
        <span class="n">search_space</span><span class="o">=</span><span class="n">sspace</span><span class="p">,</span>
        <span class="n">net</span><span class="o">=</span><span class="n">Net</span><span class="p">,</span>
        <span class="n">flops</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;FLOPS&quot;</span><span class="p">]),</span>
        <span class="n">quant_scheme</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;QUANT_SCHEME&quot;</span><span class="p">]),</span>
        <span class="n">quant_params</span><span class="o">=</span><span class="n">quant_params</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="n">bool_converter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;SPLITTER&quot;</span><span class="p">]),</span>
        <span class="n">models_path</span> <span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;ROOT&quot;</span><span class="p">],</span> <span class="s2">&quot;models&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Obtain the experiment and the data by calling the function <code class="docutils literal notranslate"><span class="pre">load_experiment</span></code></p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">exp</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sparse_exp</span><span class="o">.</span><span class="n">create_load_experiment</span><span class="p">()</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Select the arm tht you want to inspect</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exp</span><span class="o">.</span><span class="n">arms_by_name</span><span class="p">[</span><span class="s1">&#39;779_0&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="extending_sparse.html" class="btn btn-neutral float-right" title="Extending Sparse" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Juan Borrego-Carazo

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>